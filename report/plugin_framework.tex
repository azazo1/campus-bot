为了合理地分离代码中的各个逻辑部分，项目构建了插件框架，将不同的功能划分到一个个插件中。
插件框架实现了单独开启和关闭每个插件的功能，让使用者可以根据需要选择希望使用的功能。

插件框架的大致内容如下：

\subsubsection{插件加载器（PluginLoader）}
插件的加载和运行通过 PluginLoader 来驱动。

项目启动时，PluginLoader 依次导入位于项目根目录下的 \verb`plugins` 文件夹中的插件。
然后从文件中读取各个插件配置，并传递给插件。
插件配置读取完毕之后，PluginLoader 加载各个插件。
被加载的插件可以从其他插件中接收消息和按照特定周期执行（\ref{para:routine}）。

\subsubsection{插件注册（Register）}
插件注册无需直接与 PluginLoader 进行交互。
插件加载器会在项目启动的时候自动导入 plugins 文件夹下的每个 \verb`python` 包或者一个 \verb`.py` 文件，
并尝试注册其中的插件。

插件的注册通过装饰器 \verb`register_plugin` 进行。
继承插件类并通过 \verb`register_plugin` 即可注册插件：

% @formatter:off
\begin{lstlisting}[
    language={Python},
    caption={插件注册代码示例},
    captionpos=b,
    label=lst:plugin-registering,
]
@register_plugin(
    name="demo_plugin"
)
class DemoPlugin(Plugin):
    pass\end{lstlisting}
% @formatter:on

\subsubsection{插件事件方法}

成功注册后插件的各种事件方法会被触发，主要的事件方法如下。

\paragraph{插件加载和停止（Load 与 Unload）事件}

当插件被加载和停止时触发，插件的加载和停止在插件被导入之后，可能会被使用者多次触发。
用于标记当前插件是否正在运行，方便插件释放资源。


% @formatter:off
\begin{lstlisting}[
    language={Python},
    caption={插件加载和停止示例},
    captionpos=b,
    label=lst:plugin-load-unload,
]
@register_plugin(
    name="demo_plugin"
)
class DemoPlugin(Plugin):
    def on_load(self, ctx: PluginContext):
        pass
    def on_unload(self, ctx: PluginContext):
        pass\end{lstlisting}
% @formatter:on

\paragraph{插件周期事件（Routine）}\label{para:routine}
插件在注册的时候可以提供一个回调周期，插件会在指定的回调周期得到回调。

% @formatter:off
\begin{lstlisting}[
    language={Python},
    caption={插件周期事件示例},
    captionpos=b,
    label=lst:plugin-routine,
]
@register_plugin(
    name="demo_plugin",
    routine=Routine.MINUTELY
)
class DemoPlugin(Plugin):
    def on_routine(self, ctx: PluginContext):
        pass # 周期性得到回调\end{lstlisting}
% @formatter:on

\subsubsection{插件配置（PluginConfig）}
插件在插件注册时提供需要的配置，在 PluginLoader 从文件中读取插件配置的时候，获得配置的值。

插件配置会集中保存在 \verb`plugin_config.toml` 中，gui
会为每个插件配置自动生成交互式修改组件，见\ref{subsubsec:gui-plugin-config}。
使用者可以通过修改文件或者通过 gui 修改插件配置。

% @formatter:off
\begin{lstlisting}[
    language={Python},
    caption={插件配置示例},
    captionpos=b,
    label=lst:plugin-config,
]
@register_plugin(
    name="demo_plugin",
    configuration=PluginConfig()
    .add(TextItem(name="first_name", default_value="Tom", description="Your first name"))
)
class DemoPlugin(Plugin):
    def on_config_load(self, ctx: PluginContext, cfg: PluginConfig):
        first_name = cfg.get_itme("first_name").current_value\end{lstlisting}
% @formatter:on

\subsubsection{插件缓存（PluginCache）}
插件内部生成的数据可以得到统一的持久化保存。
插件只需对 PluginCache，进行修改，数据会在插件停止时保存，在插件加载时再次读取。

% @formatter:off
\begin{lstlisting}[
    language={Python},
    caption={插件缓存示例},
    captionpos=b,
    label=lst:plugin-cache,
]
@register_plugin(
    name="demo_plugin"
)
class DemoPlugin(Plugin):
    def on_load(self, ctx: PluginContext):
        ctx.get_logger().info(ctx.get_cache().get("time"))
    def on_routine(self, ctx: PluginContext):
        ctx.get_cache().set("time", time.time())\end{lstlisting}
% @formatter:on

\subsubsection{插件上下文（PluginContext）}
插件上下文为插件提供多种间接与项目交互的方式。

插件可以通过 PluginContext 进行
\begin{enumerate}
    \item 输出日志
    \item 创建可交互按钮（Bind Action）
    \item 读写缓存
    \item 向其他插件发送消息
    \item 获取登录缓存
\end{enumerate}
等操作。

\subsubsection{插件消息传递（Message）}
插件通过 PluginContext 可以向其他插件发送消息。

% @formatter:off
\begin{lstlisting}[
    language={Python},
    caption={插件发送消息示例},
    captionpos=b,
    label=lst:plugin-send-message,
]
@register_plugin(
    name="send_demo_plugin"
)
class DemoPlugin(Plugin):
    def on_routine(self, ctx: PluginContext):
        ctx.send_message("recv_demo_plugin", "Hello World")

@register_plugin(
    name="recv_demo_plugin"
)
class RecvPlugin(Plugin):
    def on_recv(self, ctx: PluginContext, from_plugin: str, obj: Any):
        ctx.get_logger().info((from_plugin, obj))\end{lstlisting}
% @formatter:on
